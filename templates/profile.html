{% extends "base.html" %}

{% block title %}Profile - KasiKash{% endblock %}

{% block content %}
<!-- Gradient Welcome Banner (Dashboard Style) -->
<div class="admin-dashboard-banner">
  <div style="flex:1;">
    <h1>Sawubona, {{ user.username }}! <span style="font-size:1.8rem;">ðŸ‘‹</span></h1>
    <p>Welcome to your profile page. Keep your information up to date for the best experience!</p>
  </div>
  <div style="margin-left: 1.5rem;">
    {% if user.profile_picture %}
      <span style="display: inline-flex; align-items: center; justify-content: center; background: rgba(96,239,255,0.10); border-radius: 50%; width: 54px; height: 54px; overflow: hidden;">
        <img src="{{ url_for('static', filename='profile_pics/' ~ user.profile_picture) }}" alt="Profile picture of {{ user.username }}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
      </span>
    {% else %}
      <span style="display: inline-flex; align-items: center; justify-content: center; background: rgba(96,239,255,0.10); border-radius: 50%; width: 54px; height: 54px;">
        <svg width="32" height="32" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#60efff" fill-opacity="0.2"/><path d="M9 12.5l2 2 4-4" stroke="#60efff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </span>
    {% endif %}
  </div>
</div>

<div class="dashboard-grid">
  <!-- Profile Card -->
  <div class="glass-card" style="grid-column: span 2;">
    <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
      <!-- Profile Picture Section -->
      <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; border: 2px solid #60a5fa; margin-bottom: 0.5rem; position: relative; cursor:pointer;" onclick="document.getElementById('profilePicInput').click()">
        {% if user.profile_picture %}
          <img src="{{ url_for('static', filename='profile_pics/' ~ user.profile_picture) }}" alt="Profile Picture" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
        {% else %}
          <i class="fas fa-user-circle" style="font-size: 3rem; color: #c7d2fe;"></i>
        {% endif %}
        <div style="position: absolute; bottom: 2px; right: 2px; width: 16px; height: 16px; background: #10B981; border-radius: 50%; border: 2px solid #101c2c;"></div>
      </div>
      <!-- Hidden form for file upload -->
      <form id="avatarUploadForm" method="POST" action="{{ url_for('upload_profile_picture') }}" enctype="multipart/form-data" style="display: none;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input id="profilePicInput" type="file" name="profile_picture" accept="image/*" onchange="uploadProfilePicture()">
      </form>
      <!-- User Info Section -->
      <div style="flex:1; min-width:220px;">
        <div class="accent text-xl mb-1">{{ user.username }}</div>
        <div class="text-white text-sm mb-3" style="opacity: 0.8;">{{ user.email }}</div>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
          <span class="dashboard-btn" style="padding: 0.3rem 1.2rem; font-size: 0.9rem;">{{ user.full_name or 'No Name' }}</span>
          {% if user.is_verified %}
            <span style="background: rgba(0,255,135,0.2); color: #00ff87; border-radius: 9999px; padding: 0.25rem 0.75rem; font-size: 0.85rem; border: 1px solid rgba(0,255,135,0.3);"><i class="fas fa-check-circle"></i> Verified</span>
          {% else %}
            <span style="background: rgba(239, 68, 68, 0.1); color: #EF4444; border-radius: 9999px; padding: 0.25rem 0.75rem; font-size: 0.85rem; border: 1px solid #EF4444;"><i class="fas fa-exclamation-circle"></i> Not Verified</span>
            <button onclick="resendVerification()" class="dashboard-btn" style="padding: 0.3rem 1.2rem; font-size: 0.9rem; background: #EF4444; color: #fff;">Resend Verification</button>
          {% endif %}
        </div>
        {% if user.last_login %}
          <div style="color: #b2f7ef; font-size: 0.9rem; margin-top: 0.5rem;">Last active: {{ user.last_login.strftime('%B %d, %Y at %I:%M %p') }}</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Personal Information Card -->
  <div class="glass-card" style="grid-column: span 2;">
    <h2 style="color: #60efff; font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem;"><i class="fas fa-user" style="margin-right:0.5rem;"></i>Personal Information</h2>
    <form id="profileUpdateForm" method="POST" action="{{ url_for('update_profile') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.2rem;">
        <div>
          <label style="color: #b2f7ef; font-size: 0.95rem;">Full Name</label>
          <input type="text" name="full_name" value="{{ user.full_name or '' }}" class="dashboard-card" style="width:100%; padding:0.7rem; margin-top:0.2rem;">
        </div>
        <div>
          <label style="color: #b2f7ef; font-size: 0.95rem;">Username</label>
          <input type="text" name="username" value="{{ user.username or '' }}" class="dashboard-card" style="width:100%; padding:0.7rem; margin-top:0.2rem;">
        </div>
        <div>
          <label style="color: #b2f7ef; font-size: 0.95rem;">Email</label>
          <input type="email" value="{{ user.email or 'No email on file' }}" disabled class="dashboard-card" style="width:100%; padding:0.7rem; margin-top:0.2rem; background:rgba(255,255,255,0.08); color:#b2f7ef;">
          <p style="color: #b2f7ef; font-size: 0.8rem; margin-top:0.2rem;">Email cannot be changed</p>
        </div>
        <div>
          <label style="color: #b2f7ef; font-size: 0.95rem;">Phone Number</label>
          <input type="tel" name="phone" value="{{ user.phone or '' }}" class="dashboard-card" style="width:100%; padding:0.7rem; margin-top:0.2rem;">
        </div>
        <div>
          <label style="color: #b2f7ef; font-size: 0.95rem;">ID Number</label>
          <input type="text" name="id_number" value="{{ user.id_number or '' }}" class="dashboard-card" style="width:100%; padding:0.7rem; margin-top:0.2rem;">
        </div>
        <div>
          <label style="color: #b2f7ef; font-size: 0.95rem;">Date of Birth</label>
          <input type="date" name="date_of_birth" value="{{ user.date_of_birth or '' }}" class="dashboard-card" style="width:100%; padding:0.7rem; margin-top:0.2rem;">
        </div>
        <div style="grid-column: span 2;">
          <label style="color: #b2f7ef; font-size: 0.95rem;">Address</label>
          <input type="text" name="address" value="{{ user.address or '' }}" class="dashboard-card" style="width:100%; padding:0.7rem; margin-top:0.2rem;">
        </div>
      </div>
      <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
        <button type="submit" class="dashboard-btn"><i class="fas fa-save" style="margin-right:0.5rem;"></i>Save Changes</button>
      </div>
    </form>
  </div>

  <!-- KYC Documents Card -->
  <div class="glass-card" style="grid-column: span 2;">
    <h2 style="color: #60efff; font-size: 1.3rem; font-weight: 700; margin-bottom: 1rem;"><i class="fas fa-id-card" style="margin-right:0.5rem;"></i>KYC Documents</h2>
    <div style="background: rgba(96,239,255,0.08); border-radius: 1rem; padding: 1.2rem; margin-bottom: 1rem;">
      <span style="color: #b2f7ef; font-size: 1.1rem; font-weight: 600;">Overall KYC Status:</span>
      <span class="dashboard-btn" style="padding: 0.3rem 1.2rem; font-size: 0.9rem; margin-left: 1rem; background: {% if user.kyc_status == 'approved' %}#00ff87{% elif user.kyc_status == 'rejected' %}#EF4444{% elif user.kyc_status == 'pending_review' %}#fbbf24{% else %}#b2f7ef{% endif %}; color: #101c2c;">
        {% if user.kyc_status == 'approved' %}<i class="fas fa-check-circle"></i> Approved{% elif user.kyc_status == 'rejected' %}<i class="fas fa-times-circle"></i> Rejected{% elif user.kyc_status == 'pending_review' %}<i class="fas fa-hourglass-half"></i> Pending Review{% else %}<i class="fas fa-question-circle"></i> Not Submitted{% endif %}
      </span>
    </div>
    <!-- Document Upload/Status Section (keep your logic here) -->
    <div style="background: rgba(255,255,255,0.03); border-radius: 1rem; padding: 1.2rem;">
      {# Place your KYC document upload/status logic here #}
    </div>
  </div>
</div>
{% endblock %}

<script>
    function uploadProfilePicture() {
        // Automatically submit the avatar form when a file is chosen
        document.getElementById('avatarUploadForm').submit();
    }
    
    function resendVerification() {
        fetch('{{ url_for("resend_verification_email") }}', { // Assumes a route named resend_verification_email
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message); // Or use a nicer notification system
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred.');
        });
    }
</script>